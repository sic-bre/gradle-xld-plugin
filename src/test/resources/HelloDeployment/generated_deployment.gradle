/**
 * THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES OF MERCHANTABILITY AND/OR FITNESS
 * FOR A PARTICULAR PURPOSE. THIS CODE AND INFORMATION ARE NOT SUPPORTED BY XEBIALABS.
 */
xldeploy {
  manifest = file('./build/generated-deployit-manifest.xml')
}

task generateDeployitManifest {
  doLast {

    def input = [
//      command: 'echo "test"',
warTask: 'war'
    ]

    mkdir buildDir
    def generated = file(buildDir.path + '/generated-deployit-manifest.xml')
    generated.write("")
    generated << """<?xml version="1.0" encoding="UTF-8"?>
<udm.DeploymentPackage version="\${noSnapshot(project.version)}" application="\${project.name}">
  <deployables>
"""

    if (input.command) {
      generated << """
    <cmd.Command name="test-command">
      <commandLine>${input.command}</commandLine>
    </cmd.Command>
"""
    }

    if (input.warTask) {
      generated << """
    <jee.War name="HelloDeployment" file="\${artifact(project.${input.warTask})}" />
"""
    }

    generated << """
  </deployables>
</udm.DeploymentPackage>
"""
  }
}

tasks.configureDar.dependsOn tasks.generateDeployitManifest
tasks.dar.dependsOn tasks.war
